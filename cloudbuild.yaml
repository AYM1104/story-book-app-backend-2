# Cloud Build設定ファイル
steps:
  # Dockerイメージをビルド
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '--no-cache', '-t', 'gcr.io/$PROJECT_ID/story-book-backend:$BUILD_ID', '.']
  
  # DockerイメージをGoogle Container Registryにプッシュ
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/story-book-backend:$BUILD_ID']
  
  # Cloud Runにデプロイ
  # 注意: 環境変数は事前に `./set-cloudrun-env.sh` で設定しておくか、
  # 初回デプロイ後に `gcloud run services update` で設定してください
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - 'story-book-backend'
      - '--image'
      - 'gcr.io/$PROJECT_ID/story-book-backend:$BUILD_ID'
      - '--region'
      - 'asia-northeast1'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--port'
      - '8080'
      - '--memory'
      - '2Gi'
      - '--cpu'
      - '2'
      - '--max-instances'
      - '10'

# 使用するイメージ
images:
  - 'gcr.io/$PROJECT_ID/story-book-backend:$BUILD_ID'

# タイムアウト設定（20分）
timeout: '1200s'
